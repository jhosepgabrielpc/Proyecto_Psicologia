<%- include('../partials/header', { title: 'Monitoreo Cl√≠nico Avanzado' }) %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<% 
    // ==========================================
    // 1. PROCESAMIENTO DE DATOS (BACKEND -> FRONTEND)
    // ==========================================
    const checkins = (locals.checkins && Array.isArray(locals.checkins)) ? locals.checkins : [];
    const tests = (locals.tests && Array.isArray(locals.tests)) ? locals.tests : [];
    const patientsList = (locals.patientsList && Array.isArray(locals.patientsList)) ? locals.patientsList : [];
    const viewingPatient = locals.viewingPatient || null;
    const user = locals.user || {};
    const currentFilter = locals.currentFilter || 7; 
    const kpis = locals.kpis || { total: 0, criticos: 0, sueno_bajo: 0, estables: 0 };
    
    // Modos de Visualizaci√≥n
    const isSelectionMode = (!viewingPatient && patientsList.length > 0);
    const isMonitoringMode = (viewingPatient || user.nombre_rol === 'Paciente');
    const hasData = checkins.length > 0;

    // URLs de Filtros
    const baseUrl = '/dashboard/monitoring';
    const patientParam = viewingPatient ? `&patient=${viewingPatient.id_paciente}` : '';
    const link7Days = `${baseUrl}?days=7${patientParam}`;
    const link30Days = `${baseUrl}?days=30${patientParam}`;

    // C√°lculos Estad√≠sticos para Vista Detallada
    let avgValue = 0; let avgDisplay = "0.0"; let widthPercent = 0; let message = "Esperando datos...";
    let trendIcon = "fa-minus"; let trendColor = "text-slate-400";

    if (hasData) {
        const sum = checkins.reduce((acc, curr) => acc + Number(curr.valencia), 0);
        avgValue = sum / checkins.length;
        avgDisplay = avgValue.toFixed(1);
        widthPercent = Math.round((avgValue / 5) * 100);
        
        if (avgValue >= 4.2) { message = "Estado √ìptimo üåü"; trendIcon = "fa-arrow-up"; trendColor = "text-emerald-500"; }
        else if (avgValue >= 3.0) { message = "Estado Estable ‚ú®"; trendIcon = "fa-minus"; trendColor = "text-amber-500"; }
        else { message = "Atenci√≥n Requerida ‚ö†Ô∏è"; trendIcon = "fa-arrow-down"; trendColor = "text-rose-500"; }
    }
%>

<div class="min-h-screen bg-slate-50 py-8 font-sans">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <% if (locals.msg === 'alert_sent') { %>
            <div class="mb-6 bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-3 rounded-xl flex items-center gap-3 shadow-sm animate-fade-in-down">
                <div class="h-8 w-8 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div>
                    <p class="font-bold text-sm">Incidencia Reportada</p>
                    <p class="text-xs">La alerta ha sido enviada al Centro de Gesti√≥n (Jimmy) correctamente.</p>
                </div>
                <button onclick="this.parentElement.remove()" class="ml-auto text-emerald-400 hover:text-emerald-600"><i class="fas fa-times"></i></button>
            </div>
        <% } %>

        <% if (isSelectionMode) { %>
            
            <div class="mb-10 animate-fade-in-down">
                <h1 class="text-2xl font-extrabold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-network-wired text-indigo-600"></i> Panel de Control de Casos
                </h1>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between hover:border-indigo-200 transition-all">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Pacientes</p>
                            <p class="text-3xl font-black text-slate-800 mt-1"><%= kpis.total %></p>
                        </div>
                        <div class="h-10 w-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-rose-100 shadow-sm flex items-center justify-between relative overflow-hidden group hover:border-rose-200 transition-all">
                        <% if (kpis.criticos > 0) { %><div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div><% } %>
                        <div>
                            <p class="text-xs font-bold text-rose-400 uppercase tracking-wider">Atenci√≥n Prioritaria</p>
                            <p class="text-3xl font-black text-rose-600 mt-1"><%= kpis.criticos %></p>
                        </div>
                        <div class="h-10 w-10 rounded-xl bg-rose-50 text-rose-600 flex items-center justify-center <%= kpis.criticos > 0 ? 'animate-pulse' : '' %>"><i class="fas fa-exclamation-triangle"></i></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between hover:border-indigo-200 transition-all">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Sue√±o Irregular</p>
                            <p class="text-3xl font-black text-indigo-900 mt-1"><%= kpis.sueno_bajo %></p>
                        </div>
                        <div class="h-10 w-10 rounded-xl bg-indigo-900 text-indigo-200 flex items-center justify-center"><i class="fas fa-moon"></i></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-emerald-100 shadow-sm flex items-center justify-between hover:border-emerald-200 transition-all">
                        <div>
                            <p class="text-xs font-bold text-emerald-400 uppercase tracking-wider">En Seguimiento</p>
                            <p class="text-3xl font-black text-emerald-600 mt-1"><%= kpis.estables %></p>
                        </div>
                        <div class="h-10 w-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center"><i class="fas fa-check-circle"></i></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden animate-slide-up">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-folder-open text-indigo-400"></i> Expedientes Activos</h3>
                    <span class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-500 shadow-sm">Vista Global</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-white text-slate-400 text-xs uppercase tracking-wider border-b border-slate-100">
                                <th class="px-6 py-4 font-bold">Paciente</th>
                                <th class="px-6 py-4 font-bold">Estado Cl√≠nico</th>
                                <th class="px-6 py-4 font-bold">√öltimo Registro</th>
                                <th class="px-6 py-4 font-bold">Calidad de Sue√±o</th>
                                <th class="px-6 py-4 font-bold text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <% patientsList.forEach(p => { 
                                const isCritical = p.ultima_valencia <= 2;
                                const moodLabel = p.ultima_valencia ? (isCritical ? 'Riesgo Detectado' : (p.ultima_valencia == 3 ? 'Estable' : '√ìptimo')) : 'Sin Datos';
                                const badgeColor = isCritical ? 'bg-rose-100 text-rose-700 border-rose-200' : (p.ultima_valencia ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-slate-100 text-slate-500 border-slate-200');
                                const sleepVal = p.ultimo_sueno || 0;
                                const sleepColor = sleepVal < 6 ? 'text-rose-500' : 'text-slate-600';
                            %>
                            <tr class="hover:bg-slate-50/80 transition-colors group">
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold border border-indigo-200 text-sm shadow-sm">
                                            <%= p.nombre.charAt(0) %>
                                        </div>
                                        <div>
                                            <p class="font-bold text-slate-800 text-sm"><%= p.nombre %> <%= p.apellido %></p>
                                            <p class="text-xs text-slate-400"><%= p.email %></p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold border <%= badgeColor %>">
                                        <span class="w-1.5 h-1.5 rounded-full <%= isCritical ? 'bg-rose-500 animate-pulse' : (p.ultima_valencia ? 'bg-emerald-500' : 'bg-slate-400') %>"></span>
                                        <%= moodLabel %>
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <% if (p.ultimo_checkin) { %>
                                        <p class="text-sm font-medium text-slate-700"><%= new Date(p.ultimo_checkin).toLocaleDateString() %></p>
                                        <p class="text-xs text-slate-400"><%= new Date(p.ultimo_checkin).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) %></p>
                                    <% } else { %> <span class="text-xs text-slate-400 italic">--</span> <% } %>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-bed <%= sleepColor %>"></i>
                                        <div class="w-24 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full rounded-full <%= sleepVal < 6 ? 'bg-rose-400' : 'bg-indigo-400' %>" style="width: <%= (sleepVal/12)*100 %>%"></div>
                                        </div>
                                        <span class="text-xs font-bold <%= sleepColor %>"><%= sleepVal %>h</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex justify-end gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                        <% if (isCritical) { %>
                                            <button onclick="openAlertModal('<%= p.id_paciente %>', '<%= p.nombre %> <%= p.apellido %>', '<%= p.ultima_valencia %>', '<%= p.ultima_emocion %>', '<%= p.ultimas_notas ? p.ultimas_notas.replace(/'/g, "\\'") : '' %>', '<%= p.ultimo_sueno %>')" 
                                                    class="bg-white text-rose-600 hover:bg-rose-50 border border-rose-200 px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1 shadow-sm"
                                                    title="Generar Informe de Alerta">
                                                <i class="fas fa-bell"></i> Informe
                                            </button>
                                        <% } %>
                                        <a href="/dashboard/monitoring?patient=<%= p.id_paciente %>" class="bg-indigo-600 text-white hover:bg-indigo-700 border border-transparent px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-md flex items-center gap-1">
                                            <i class="fas fa-chart-line"></i> Ver
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>

        <% } else if (isMonitoringMode) { %>
            
            <div class="flex flex-col xl:flex-row justify-between items-end mb-8 gap-6 animate-fade-in">
                <div class="w-full xl:w-auto">
                    <a href="/dashboard/monitoring" class="text-xs font-bold text-slate-400 hover:text-indigo-600 mb-3 inline-flex items-center gap-1 transition-colors <%= user.nombre_rol === 'Paciente' ? 'hidden' : '' %>">
                        <i class="fas fa-arrow-left"></i> Volver a la lista
                    </a>
                    <h1 class="text-3xl font-extrabold text-slate-900 leading-tight">
                        <% if (viewingPatient) { %>
                            An√°lisis Cl√≠nico: <span class="text-indigo-600"><%= viewingPatient.nombre %> <%= viewingPatient.apellido %></span>
                        <% } else { %>
                            Tu Bienestar <span class="text-indigo-600">Emocional</span>
                        <% } %>
                    </h1>
                    <p class="text-slate-500 text-sm mt-1">Correlaci√≥n biom√©trica de sue√±o vs. estado an√≠mico.</p>
                </div>

                <div class="flex flex-wrap items-center gap-3">
                    <div class="bg-white p-1 rounded-xl border border-slate-200 flex shadow-sm">
                        <a href="<%= link7Days %>" class="px-4 py-2 rounded-lg text-xs font-bold transition-all <%= currentFilter === 7 ? 'bg-indigo-50 text-indigo-700' : 'text-slate-500 hover:text-slate-700' %>">7 D√≠as</a>
                        <a href="<%= link30Days %>" class="px-4 py-2 rounded-lg text-xs font-bold transition-all <%= currentFilter === 30 ? 'bg-indigo-50 text-indigo-700' : 'text-slate-500 hover:text-slate-700' %>">30 D√≠as</a>
                    </div>
                    
                    <button onclick="downloadPDF()" class="bg-white text-slate-700 border border-slate-200 px-5 py-2.5 rounded-xl font-bold shadow-sm hover:bg-slate-50 hover:text-indigo-600 transition-all text-sm flex items-center gap-2">
                        <i class="fas fa-file-pdf text-rose-500"></i> <span>Exportar</span>
                    </button>

                    <% if (user.nombre_rol === 'Paciente') { %>
                        <button onclick="toggleModal('checkinModal')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg flex items-center gap-2 transition-all transform active:scale-95">
                            <i class="fas fa-plus"></i> <span>Registrar</span>
                        </button>
                    <% } %>
                </div>
            </div>

            <div id="monitoring-content" class="space-y-8 animate-slide-up">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="font-bold text-slate-800 text-lg">Correlaci√≥n Sue√±o / √Ånimo</h3>
                                <p class="text-xs text-slate-400">Barras: Horas de Sue√±o | L√≠nea: Estado de √Ånimo</p>
                            </div>
                            <div class="flex items-center gap-2 px-3 py-1 bg-slate-50 rounded-lg border border-slate-100">
                                <i class="fas <%= trendIcon %> <%= trendColor %> text-xs"></i><span class="text-xs font-bold text-slate-600">Tendencia</span>
                            </div>
                        </div>
                        <div class="relative h-72 w-full">
                            <% if (hasData) { %> <canvas id="moodChart"></canvas> <% } else { %> <div class="h-full flex flex-col items-center justify-center text-slate-300 bg-slate-50/50 rounded-xl border-2 border-dashed border-slate-200"><p class="font-medium text-xs">Insuficientes datos.</p></div> <% } %>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col">
                        <div class="mb-4"><h3 class="font-bold text-slate-800 text-lg">Perfil Emocional</h3><p class="text-xs text-slate-400">Distribuci√≥n de emociones.</p></div>
                        <div class="relative flex-1 flex items-center justify-center min-h-[250px]">
                            <% if (hasData) { %> <canvas id="radarChart"></canvas> <% } else { %> <div class="text-center text-slate-300"><p class="text-xs">Sin datos.</p></div> <% } %>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                            <div class="flex items-center gap-2"><i class="fas fa-list-ul text-indigo-400"></i><h3 class="font-bold text-slate-800">Bit√°cora de Registros</h3></div>
                            <span class="bg-white border border-slate-200 text-slate-600 text-[10px] font-bold px-2 py-1 rounded-md uppercase">Total: <%= checkins.length %></span>
                        </div>
                        <div class="divide-y divide-slate-50 max-h-[400px] overflow-y-auto custom-scrollbar">
                            <% if (hasData) { %>
                                <% checkins.forEach(c => { %>
                                    <div class="p-5 flex items-start justify-between hover:bg-slate-50 transition-colors group">
                                        <div class="flex gap-4">
                                            <div class="flex-shrink-0 h-12 w-12 rounded-2xl flex items-center justify-center text-2xl shadow-sm border border-slate-100 bg-white">
                                                <%= c.emocion_principal.includes('Feliz') ? 'üòÑ' : c.emocion_principal.includes('Triste') ? 'üò¢' : c.emocion_principal.includes('Ansioso') ? 'üò∞' : c.emocion_principal.includes('Enojado') ? 'üò†' : 'üòê' %>
                                            </div>
                                            <div>
                                                <h4 class="text-sm font-bold text-slate-900"><%= c.emocion_principal %></h4>
                                                <p class="text-xs text-slate-400 mt-0.5 flex items-center gap-2">
                                                    <span><%= new Date(c.fecha_hora).toLocaleDateString() %></span>
                                                    <span class="text-indigo-500 bg-indigo-50 px-1.5 rounded font-bold"><i class="fas fa-bed text-[10px]"></i> <%= c.horas_sueno || 0 %>h</span>
                                                </p>
                                                <% if (c.notas) { %> <p class="text-xs text-slate-500 mt-2 italic">"<%= c.notas %>"</p> <% } %>
                                            </div>
                                        </div>
                                        <span class="text-lg font-extrabold text-indigo-600"><%= c.valencia %>/5</span>
                                    </div>
                                <% }) %>
                            <% } else { %> <div class="p-12 text-center text-slate-500 text-sm">No hay registros.</div> <% } %>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mr-6 -mt-6 w-32 h-32 bg-indigo-500 rounded-full blur-3xl opacity-20"></div>
                            <h3 class="text-slate-400 text-xs font-bold uppercase mb-2 relative z-10">Score General</h3>
                            <span class="text-5xl font-black tracking-tight relative z-10"><%= avgDisplay %></span>
                            <span class="text-slate-400 text-lg font-medium relative z-10">/ 5.0</span>
                            <div class="mt-5 h-1.5 bg-white/10 rounded-full overflow-hidden relative z-10"><div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full rounded-full" style="width: <%= widthPercent %>%"></div></div>
                            <p class="mt-4 text-sm font-medium pt-4 border-t border-white/10 relative z-10"><%= message %></p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-slate-800 mb-4 flex justify-between items-center">Evaluaciones <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold"><%= tests.length %></span></h3>
                            <div class="space-y-3">
                                <% tests.forEach((t, index) => { %>
                                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 flex justify-between items-center">
                                        <div><p class="text-xs font-bold text-slate-900"><%= t.tipo_test %></p><p class="text-[10px] text-slate-400"><%= new Date(t.fecha_realizacion).toLocaleDateString() %></p></div>
                                        <button onclick="showTestDetails(<%= index %>)" class="text-[10px] font-bold text-indigo-600 hover:underline">VER DETALLE</button>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        <% } else { %>
            <div class="min-h-[60vh] flex flex-col items-center justify-center text-center p-8">
                <h2 class="text-2xl font-bold text-slate-800">Panel de Monitoreo</h2>
                <p class="text-slate-500 mt-2">Seleccione una opci√≥n o espere a la carga.</p>
            </div>
        <% } %>
    </div>
</div>

<div id="alertModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in-up">
        <div class="bg-rose-600 px-6 py-4 flex justify-between items-center">
            <h3 class="text-white font-bold flex items-center gap-2"><i class="fas fa-tower-broadcast"></i> Confirmar Alerta</h3>
            <button onclick="closeAlertModal()" class="text-white/80 hover:text-white p-1"><i class="fas fa-times"></i></button>
        </div>
        
        <form action="/dashboard/monitoring/alert-jimmy" method="POST" class="p-6">
            <input type="hidden" name="id_paciente" id="form_id_paciente">
            <input type="hidden" name="valencia" id="form_valencia">
            <input type="hidden" name="emocion" id="form_emocion">
            <input type="hidden" name="notas" id="form_notas">
            <input type="hidden" name="sueno" id="form_sueno">

            <div class="flex items-center gap-3 mb-4 p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                <div class="h-10 w-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold">J</div>
                <div>
                    <p class="text-xs font-bold text-indigo-600 uppercase">Destinatario</p>
                    <p class="text-sm font-bold text-slate-800">Centro de Comando (Jimmy)</p>
                </div>
            </div>

            <p class="text-sm text-slate-500 mb-3">Se enviar√° el siguiente reporte para gesti√≥n inmediata:</p>
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6"><div id="previewText" class="text-sm text-slate-700 font-mono whitespace-pre-line"></div></div>

            <div class="flex gap-3 justify-end">
                <button type="button" onclick="closeAlertModal()" class="px-4 py-2 text-slate-500 font-bold text-sm hover:bg-slate-50 rounded-lg">Cancelar</button>
                <button type="submit" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg">Enviar Alerta</button>
            </div>
        </form>
    </div>
</div>

<% if (user.nombre_rol === 'Paciente') { %>
    <div id="checkinModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-50 flex items-center justify-center p-4 transition-all duration-300 opacity-0" style="opacity: 0;">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-all duration-300" id="checkinModalContent">
            <div class="bg-indigo-600 px-6 py-5 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold">Registro Diario</h3>
                <button onclick="toggleModal('checkinModal')" class="text-white/60 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form action="/dashboard/monitoring/checkin" method="POST" class="p-6 space-y-6">
                <div class="space-y-3"><div class="flex justify-between items-end"><label class="text-sm font-bold text-slate-700">√Ånimo</label><span id="moodText" class="text-indigo-600 font-bold text-lg">Normal</span></div><input type="range" name="valencia" min="1" max="5" step="1" value="3" class="w-full h-2 bg-slate-200 rounded-lg accent-indigo-600 cursor-pointer" oninput="updateMoodLabel(this.value)"></div>
                <div class="space-y-3 pt-2 border-t border-slate-100"><div class="flex justify-between items-end"><label class="text-sm font-bold text-slate-700">Sue√±o</label><span id="sleepText" class="text-slate-600 font-bold text-lg">8h</span></div><input type="range" name="horas_sueno" min="0" max="12" step="1" value="8" class="w-full h-2 bg-slate-200 rounded-lg accent-indigo-400 cursor-pointer" oninput="document.getElementById('sleepText').innerText = this.value + 'h'"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-3">Emoci√≥n</label><div class="grid grid-cols-3 gap-3"><% const emojis = {Feliz:'üòÑ', Calmado:'üòå', Cansado:'üò¥', Ansioso:'üò∞', Triste:'üò¢', Enojado:'üò†'}; %><% Object.keys(emojis).forEach(emo => { %><label class="cursor-pointer group relative"><input type="radio" name="emocion" value="<%= emo %>" class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 border border-slate-200 rounded-2xl p-3 text-center hover:border-indigo-300 transition-all shadow-sm"><div class="text-2xl mb-1"><%= emojis[emo] %></div><span class="text-[10px] font-bold block opacity-70 peer-checked:opacity-100"><%= emo %></span></div></label><% }); %></div></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-2">Notas</label><textarea name="notas" rows="2" class="w-full rounded-xl border-slate-200 text-sm focus:ring-2 resize-none p-3 bg-slate-50"></textarea></div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-700 shadow-xl transition-all">Guardar</button>
            </form>
        </div>
    </div>
<% } %>

<div id="testDetailModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[85vh] flex flex-col animate-fade-in-up">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-2xl"><h3 class="text-lg font-bold text-slate-800" id="testModalTitle">Resultados</h3><button onclick="toggleModal('testDetailModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button></div>
        <div class="p-6 overflow-y-auto custom-scrollbar" id="testModalContent"></div>
    </div>
</div>

<script>
    // DATA & CHARTS
    const rawData = '<%- JSON.stringify(checkins || []) %>'; const checkinData = JSON.parse(rawData).reverse();
    const rawTests = '<%- JSON.stringify(tests || []) %>'; const testsData = JSON.parse(rawTests);
    const emotionMap = { 'Feliz': 0, 'Calmado': 0, 'Cansado': 0, 'Triste': 0, 'Ansioso': 0, 'Enojado': 0 };
    checkinData.forEach(c => { if (c.emocion_principal && emotionMap.hasOwnProperty(c.emocion_principal)) emotionMap[c.emocion_principal]++; });
    
    document.addEventListener('DOMContentLoaded', function() {
        const ctxLine = document.getElementById('moodChart');
        if (ctxLine && checkinData.length > 0) {
            new Chart(ctxLine, {
                type: 'bar',
                data: {
                    labels: checkinData.map(c => new Date(c.fecha_hora).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })),
                    datasets: [
                        { type: 'line', label: '√Ånimo', data: checkinData.map(c => c.valencia), borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', borderWidth: 3, tension: 0.4, yAxisID: 'y' },
                        { type: 'bar', label: 'Sue√±o', data: checkinData.map(c => c.horas_sueno || 0), backgroundColor: 'rgba(203, 213, 225, 0.5)', borderRadius: 4, yAxisID: 'y1' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 6, position: 'left' }, y1: { min: 0, max: 12, position: 'right', grid: { display: false } }, x: { grid: { display: false } } } }
            });
        }
        const ctxRadar = document.getElementById('radarChart');
        if (ctxRadar && checkinData.length > 0) {
            new Chart(ctxRadar, { type: 'radar', data: { labels: Object.keys(emotionMap), datasets: [{ label: 'Frecuencia', data: Object.values(emotionMap), backgroundColor: 'rgba(244, 63, 94, 0.2)', borderColor: '#f43f5e', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { grid: { color: '#f1f5f9' }, ticks: { display: false, backdropColor: 'transparent' } } } } });
        }
    });

    // UI FUNCTIONS
    function openAlertModal(id, name, valencia, emotion, notes, sleep) {
        document.getElementById('form_id_paciente').value = id;
        document.getElementById('form_valencia').value = valencia;
        document.getElementById('form_emocion').value = emotion;
        document.getElementById('form_notas').value = notes;
        document.getElementById('form_sueno').value = sleep;
        document.getElementById('previewText').innerText = `PACIENTE: ${name}\nESTADO: ${valencia}/5 (${emotion})\nSUE√ëO: ${sleep}h\nOBS: ${notes}`;
        document.getElementById('alertModal').classList.remove('hidden');
    }
    function closeAlertModal() { document.getElementById('alertModal').classList.add('hidden'); }
    
    function toggleModal(id) {
        const modal = document.getElementById(id);
        const content = document.getElementById('checkinModalContent');
        if (modal.classList.contains('hidden')) { modal.classList.remove('hidden'); setTimeout(() => { modal.style.opacity = '1'; if(content) content.classList.replace('scale-95', 'scale-100'); }, 10); }
        else { modal.style.opacity = '0'; if(content) content.classList.replace('scale-100', 'scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
    }
    function updateMoodLabel(v) { const l = {1:'P√©simo', 2:'Mal', 3:'Normal', 4:'Bien', 5:'Excelente'}; document.getElementById('moodText').innerText = l[v] || 'Normal'; }
    
    function showTestDetails(i) {
        const t = testsData[i];
        if(!t) return;
        let html = `<div class="mb-6 p-5 rounded-2xl bg-indigo-50 text-center"><p class="text-3xl font-black text-indigo-700">${t.severidad}</p><p class="text-sm">Puntaje: ${t.puntaje_total}</p></div>`;
        try {
            const ans = typeof t.respuestas_json === 'string' ? JSON.parse(t.respuestas_json) : t.respuestas_json;
            Object.keys(ans).forEach((k, idx) => { if (k.startsWith('P') || !isNaN(k)) html += `<div class="flex justify-between py-2 border-b"><span class="font-bold text-xs bg-slate-200 px-2 rounded">P${idx+1}</span><span class="text-sm">${ans[k]}</span></div>`; });
        } catch(e){}
        document.getElementById('testModalContent').innerHTML = html;
        toggleModal('testDetailModal');
    }
    function downloadPDF() {
        const el = document.getElementById('monitoring-content');
        const btn = document.querySelector('button[onclick="downloadPDF()"]');
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
        html2pdf().set({ margin:0.4, filename:'Reporte.pdf', image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'letter'} }).from(el).save().then(() => btn.innerHTML = '<i class="fas fa-file-pdf text-rose-500"></i> Exportar');
    }
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .animate-fade-in-down { animation: fade-in-down 0.5s ease-out; }
    .animate-slide-up { animation: slide-up 0.5s ease-out; }
    @keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slide-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<%- include('../partials/footer') %>