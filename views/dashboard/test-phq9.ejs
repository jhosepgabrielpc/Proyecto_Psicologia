<%- include('../partials/header', { title: `Evaluaci칩n ${testType.toUpperCase()}` }) %>

<div class="min-h-screen bg-slate-50 py-10 font-sans">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 mb-8">
            <div class="flex items-start gap-6">
                <div class="hidden md:flex flex-shrink-0 bg-indigo-50 text-indigo-600 p-4 rounded-xl">
                    <i class="fas fa-clipboard-list text-4xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900">
                        <%= testType === 'phq9' ? 'Cuestionario de Salud (PHQ-9)' : 'Escala de Ansiedad (GAD-7)' %>
                    </h1>
                    <p class="text-slate-500 mt-2 text-lg leading-relaxed">
                        Durante las <strong>칰ltimas 2 semanas</strong>, 쯖on qu칠 frecuencia le han molestado los siguientes problemas?
                    </p>
                    <div class="mt-4 flex gap-2 text-sm">
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold">Confidencial</span>
                        <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full font-bold">Tiempo estimado: 2 min</span>
                    </div>
                </div>
            </div>
        </div>

        <form id="testForm" class="space-y-6">
            
            <% 
                // L칍GICA PARA SELECCIONAR PREGUNTAS SEG칔N EL TIPO DE TEST
                let questions = [];
                
                if (testType === 'phq9') {
                    questions = [
                        "Tener poco inter칠s o placer en hacer las cosas.",
                        "Sentirse desanimado/a, deprimido/a o sin esperanza.",
                        "Tener problemas para dormir o mantenerse dormido/a, o dormir demasiado.",
                        "Sentirse cansado/a o tener poca energ칤a.",
                        "Tener poco apetito o comer en exceso.",
                        "Sentirse mal con usted mismo/a (sentirse fracasado/a o que se ha fallado a s칤 mismo/a o a su familia).",
                        "Tener dificultad para concentrarse en ciertas cosas, tales como leer el peri칩dico o ver la televisi칩n.",
                        "Moverse o hablar tan lentamente que otras personas podr칤an haberlo notado. O lo contrario: estar tan inquieto/a o agitado/a que se ha estado moviendo mucho m치s de lo habitual.",
                        "Pensamientos de que ser칤a mejor estar muerto/a o de lastimarse de alguna manera."
                    ];
                } else if (testType === 'gad7') {
                    questions = [
                        "Sentirse nervioso/a, ansioso/a o con los nervios de punta.",
                        "No poder dejar de preocuparse o no poder controlar la preocupaci칩n.",
                        "Preocuparse demasiado por diferentes cosas.",
                        "Dificultad para relajarse.",
                        "Estar tan inquieto/a que es dif칤cil permanecer sentado/a.",
                        "Molestarse o irritarse f치cilmente.",
                        "Sentir miedo como si algo terrible fuera a pasar."
                    ];
                }
                
                const options = [
                    { val: 0, text: "Para nada" },
                    { val: 1, text: "Varios d칤as" },
                    { val: 2, text: "M치s de la mitad de los d칤as" },
                    { val: 3, text: "Casi todos los d칤as" }
                ];
            %>

            <% questions.forEach((question, index) => { %>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all hover:shadow-md">
                    <div class="p-6 border-b border-slate-50 bg-slate-50/50">
                        <h3 class="text-lg font-bold text-slate-800 flex gap-3">
                            <span class="flex-shrink-0 bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-sm">
                                <%= index + 1 %>
                            </span>
                            <%= question %>
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <% options.forEach(opt => { %>
                                <label class="relative cursor-pointer group">
                                    <input type="radio" name="q<%= index %>" value="<%= opt.val %>" class="peer sr-only" required>
                                    <div class="p-4 rounded-xl border-2 border-slate-100 text-center transition-all
                                                peer-checked:border-indigo-500 peer-checked:bg-indigo-50 peer-checked:text-indigo-700
                                                group-hover:border-slate-300">
                                        <div class="text-xl mb-1 opacity-50 peer-checked:opacity-100 peer-checked:scale-110 transition-transform">
                                            <% if(opt.val === 0) { %> 游뗵
                                            <% } else if(opt.val === 1) { %> 游땛
                                            <% } else if(opt.val === 2) { %> 游
                                            <% } else { %> 游땲 <% } %>
                                        </div>
                                        <span class="text-sm font-bold block"><%= opt.text %></span>
                                    </div>
                                    <div class="absolute top-3 right-3 opacity-0 peer-checked:opacity-100 transition-opacity text-indigo-600">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </label>
                            <% }); %>
                        </div>
                    </div>
                </div>
            <% }); %>

            <div class="flex items-center justify-end gap-4 pt-4">
                <a href="/dashboard/patient" class="text-slate-500 font-bold hover:text-slate-700 px-6 py-3">Cancelar</a>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all flex items-center gap-2">
                    <span>Enviar Evaluaci칩n</span>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

        </form>
    </div>
</div>

<div id="successModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center transform scale-95 transition-transform" id="modalCard">
        <div class="w-20 h-20 bg-emerald-100 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-inner">
            <i class="fas fa-check"></i>
        </div>
        <h2 class="text-2xl font-extrabold text-slate-900 mb-2">춰Evaluaci칩n Completada!</h2>
        <p class="text-slate-500 mb-8">Tus respuestas han sido guardadas. Tu terapeuta recibir치 una notificaci칩n si es necesario.</p>
        
        <div class="bg-slate-50 rounded-xl p-4 mb-8 border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Resultado Preliminar</p>
            <h3 class="text-xl font-bold text-indigo-600" id="resultSeverity">Calculando...</h3>
            <p class="text-sm text-slate-500 mt-1">Puntaje: <span id="resultScore">0</span></p>
        </div>

        <a href="/dashboard/monitoring" class="block w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition shadow-lg">
            Ver mi Progreso
        </a>
    </div>
</div>

<script>
    const form = document.getElementById('testForm');
    const modal = document.getElementById('successModal');
    const modalCard = document.getElementById('modalCard');
    const resultText = document.getElementById('resultSeverity');
    const resultScore = document.getElementById('resultScore');
    
    // Variable inyectada desde el backend
    const testType = "<%= testType %>".toUpperCase(); 
    const totalQuestions = <%= questions.length %>;

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const answers = [];
        
        // Recopilar respuestas din치micamente seg칰n la cantidad de preguntas
        for (let i = 0; i < totalQuestions; i++) {
            const val = formData.get(`q${i}`);
            if (val === null) {
                alert('Por favor responde todas las preguntas.');
                return;
            }
            answers.push(parseInt(val));
        }

        try {
            const response = await fetch('/dashboard/test/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tipo_test: testType === 'PHQ9' ? 'PHQ-9' : 'GAD-7', // Normalizar nombre para la BD
                    respuestas: answers
                })
            });

            const data = await response.json();

            if (data.success) {
                resultText.innerText = data.severidad;
                resultScore.innerText = data.puntaje + (testType === 'PHQ9' ? '/27' : '/21');
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modalCard.classList.remove('scale-95');
                    modalCard.classList.add('scale-100');
                }, 10);
            } else {
                alert('Error al guardar: ' + (data.error || 'Intente nuevamente'));
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi칩n.');
        }
    });
</script>

<%- include('../partials/footer') %>