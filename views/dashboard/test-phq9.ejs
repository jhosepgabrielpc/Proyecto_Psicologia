<%- include('../partials/header', { title: 'Nuevo Paciente' }) %>

<div class="min-h-screen bg-gradient-to-b from-slate-50 via-slate-50 to-indigo-50/40 py-10 font-sans">
    <div class="max-w-5xl mx-auto px-4">
        
        <div class="flex items-center justify-between mb-6">
            <a href="/dashboard/therapist" class="inline-flex items-center text-sm font-bold text-slate-400 hover:text-indigo-600 transition-colors group">
                <span class="h-8 w-8 rounded-full border border-slate-200 flex items-center justify-center mr-2 group-hover:border-indigo-400">
                    <i class="fas fa-arrow-left text-xs"></i>
                </span>
                Volver al Panel
            </a>

            <div class="hidden sm:flex items-center gap-2 text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-emerald-400 mr-1"></span>
                Sesión segura • MindCare
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,1.6fr)_minmax(0,1fr)] gap-6 items-start">

            <!-- CARD PRINCIPAL FORMULARIO -->
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                <div class="bg-gradient-to-r from-indigo-600 via-indigo-500 to-indigo-600 px-8 py-6 relative">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-400/30 rounded-full blur-3xl"></div>
                    <div class="absolute -bottom-10 right-10 w-32 h-32 bg-sky-400/30 rounded-full blur-3xl"></div>

                    <div class="relative z-10">
                        <div class="flex items-center justify-between gap-4">
                            <div>
                                <h1 class="text-2xl sm:text-3xl font-extrabold text-white flex items-center gap-3">
                                    <span class="inline-flex h-10 w-10 rounded-2xl bg-white/10 border border-indigo-200/50 items-center justify-center shadow-sm">
                                        <i class="fas fa-user-plus text-lg"></i>
                                    </span>
                                    Registrar Paciente
                                </h1>
                                <p class="text-indigo-100 text-sm mt-1 max-w-md">
                                    Crea una cuenta para tu paciente y se asignará automáticamente a tu cartera clínica.
                                </p>
                            </div>
                            <div class="hidden sm:flex flex-col items-end">
                                <span class="text-[11px] font-semibold text-indigo-100/80 uppercase tracking-widest">
                                    Flujo rápido
                                </span>
                                <span class="mt-1 inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white/10 text-[11px] text-indigo-50 font-bold">
                                    <i class="fas fa-bolt text-amber-300"></i> <span>Menos de 1 minuto</span>
                                </span>
                            </div>
                        </div>

                        <!-- Mini “pasos” visuales -->
                        <div class="mt-5 flex items-center gap-3 text-[10px] text-indigo-100 font-semibold uppercase tracking-widest">
                            <div class="flex items-center gap-2">
                                <span class="h-5 w-5 rounded-full bg-emerald-400 text-slate-900 flex items-center justify-center text-[9px] font-black shadow-sm">
                                    1
                                </span>
                                <span>Datos de acceso</span>
                            </div>
                            <div class="h-px w-6 bg-indigo-200/60"></div>
                            <div class="flex items-center gap-2 opacity-80">
                                <span class="h-5 w-5 rounded-full border border-indigo-200 text-indigo-50 flex items-center justify-center text-[9px] font-black">
                                    2
                                </span>
                                <span>Primer contacto</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <% if (error) { %>
                        <div class="mb-6 bg-rose-50 border border-rose-200 text-rose-600 px-4 py-3 rounded-xl text-sm font-bold flex items-center gap-2">
                            <i class="fas fa-exclamation-circle"></i> <%= error %>
                        </div>
                    <% } %>
                    
                    <% if (success) { %>
                        <div class="mb-6 bg-emerald-50 border border-emerald-200 text-emerald-600 px-4 py-3 rounded-xl text-sm font-bold flex items-center gap-2">
                            <i class="fas fa-check-circle"></i> <%= success %>
                        </div>
                    <% } %>

                    <form action="/dashboard/register-patient" method="POST" class="space-y-7" id="registerPatientForm">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">
                                    Nombre
                                </label>
                                <input 
                                    type="text" 
                                    name="nombre" 
                                    required 
                                    class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none text-sm"
                                    placeholder="Ej: Juan"
                                    id="inputNombre"
                                >
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">
                                    Apellido
                                </label>
                                <input 
                                    type="text" 
                                    name="apellido" 
                                    required 
                                    class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none text-sm"
                                    placeholder="Ej: Pérez"
                                    id="inputApellido"
                                >
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">
                                    Correo Electrónico
                                </label>
                                <div class="relative">
                                    <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input 
                                        type="email" 
                                        name="email" 
                                        required 
                                        class="w-full pl-11 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none text-sm" 
                                        placeholder="correo@paciente.com"
                                        id="inputEmail"
                                    >
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1 ml-1">
                                    Es recomendable usar el correo personal del paciente.
                                </p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">
                                    Teléfono <span class="text-slate-400 font-normal normal-case">(Opcional)</span>
                                </label>
                                <input 
                                    type="tel" 
                                    name="telefono" 
                                    class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none text-sm" 
                                    placeholder="+591 ..."
                                    id="inputTelefono"
                                >
                                <p class="text-[10px] text-slate-400 mt-1 ml-1">
                                    Útil para recordatorios por WhatsApp o SMS.
                                </p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">
                                    Contraseña Temporal
                                </label>
                                <div class="relative">
                                    <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                                    <input 
                                        type="password" 
                                        name="password" 
                                        required 
                                        class="w-full pl-11 pr-12 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none text-sm" 
                                        placeholder="******"
                                        id="inputPassword"
                                    >
                                    <button 
                                        type="button"
                                        id="btnGeneratePass"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-[11px] font-bold text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded-lg border border-indigo-100"
                                    >
                                        Sugerir
                                    </button>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1 ml-1">
                                    Comparte esta clave con el paciente. Podrá cambiarla luego desde su perfil.
                                </p>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">
                                    Notas internas <span class="text-slate-400 font-normal normal-case">(no visible al paciente)</span>
                                </label>
                                <textarea
                                    class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none text-xs resize-none h-[68px]"
                                    placeholder="Ej: Derivado por médico de cabecera / Primera consulta por ansiedad leve..."
                                    name="nota_interna"
                                ></textarea>
                            </div>
                        </div>

                        <div class="pt-4 flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-2 text-[11px] text-slate-400">
                                <i class="fas fa-shield-alt"></i>
                                <span>Los datos serán almacenados de forma segura en MindCare.</span>
                            </div>
                            <button 
                                type="submit" 
                                class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-8 py-3.5 rounded-xl shadow-lg hover:shadow-indigo-500/30 transition-all transform active:scale-[0.98] flex justify-center items-center gap-2 text-sm"
                            >
                                <span>Crear Expediente</span> 
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>

                    </form>
                </div>
            </div>

            <!-- PANEL LATERAL: RESUMEN EN TIEMPO REAL -->
            <aside class="hidden lg:block">
                <div class="bg-white/80 backdrop-blur rounded-3xl shadow-lg border border-slate-100 p-6 sticky top-24">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">
                            Previsualización del paciente
                        </p>
                        <span class="inline-flex items-center gap-1 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            En tiempo real
                        </span>
                    </div>

                    <div class="bg-gradient-to-b from-slate-900 to-slate-800 rounded-2xl p-5 text-slate-50 shadow-inner">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="h-12 w-12 rounded-2xl bg-indigo-500/40 border border-indigo-200/60 flex items-center justify-center text-xl font-bold" id="previewAvatar">
                                <span id="previewInitials">MC</span>
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-slate-300 uppercase tracking-widest">Paciente</p>
                                <p class="text-sm font-bold mt-0.5" id="previewName">Nombre Apellido</p>
                                <p class="text-[11px] text-slate-400 mt-0.5" id="previewEmail">correo@paciente.com</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 text-[11px]">
                            <div class="bg-slate-800/70 rounded-xl p-3 border border-slate-700">
                                <p class="text-slate-400 font-semibold uppercase tracking-wider text-[9px] mb-1">
                                    Estado inicial
                                </p>
                                <p class="font-bold text-emerald-400">Pendiente de primera cita</p>
                            </div>
                            <div class="bg-slate-800/70 rounded-xl p-3 border border-slate-700">
                                <p class="text-slate-400 font-semibold uppercase tracking-wider text-[9px] mb-1">
                                    Acceso
                                </p>
                                <p class="font-bold text-slate-50 truncate" id="previewAccess">
                                    Usuario creado
                                </p>
                            </div>
                        </div>

                        <div class="mt-4 text-[10px] text-slate-400 leading-relaxed">
                            Recuerda comunicar al paciente que esta cuenta es solo para uso personal, 
                            y que los resultados de pruebas y sesiones serán visibles solo para su terapeuta.
                        </div>
                    </div>
                </div>
            </aside>

        </div>
    </div>
</div>

<script>
    // Previsualización en tiempo real (solo UX, no afecta al backend)
    const inputNombre = document.getElementById('inputNombre');
    const inputApellido = document.getElementById('inputApellido');
    const inputEmail = document.getElementById('inputEmail');
    const inputPassword = document.getElementById('inputPassword');
    const previewName = document.getElementById('previewName');
    const previewEmail = document.getElementById('previewEmail');
    const previewInitials = document.getElementById('previewInitials');
    const previewAccess = document.getElementById('previewAccess');
    const btnGeneratePass = document.getElementById('btnGeneratePass');

    function updatePreview() {
        const nombre = inputNombre.value.trim() || 'Nombre';
        const apellido = inputApellido.value.trim() || 'Apellido';
        const email = inputEmail.value.trim() || 'correo@paciente.com';
        
        previewName.textContent = `${nombre} ${apellido}`.trim();
        previewEmail.textContent = email;

        const nInitial = nombre.charAt(0) || 'M';
        const aInitial = apellido.charAt(0) || 'C';
        previewInitials.textContent = (nInitial + aInitial).toUpperCase();
    }

    inputNombre && inputNombre.addEventListener('input', updatePreview);
    inputApellido && inputApellido.addEventListener('input', updatePreview);
    inputEmail && inputEmail.addEventListener('input', updatePreview);

    updatePreview();

    // Generador rápido de contraseña sugerida
    btnGeneratePass?.addEventListener('click', () => {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789';
        let pass = '';
        for (let i = 0; i < 8; i++) {
            pass += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        inputPassword.value = pass;
        previewAccess.textContent = 'Contraseña temporal generada';
    });
</script>

<%- include('../partials/footer') %>
