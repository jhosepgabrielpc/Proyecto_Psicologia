<%- include('../partials/header', { title: 'Mi Espacio - MindCare' }) %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .gradient-text {
        background: linear-gradient(to right, #4f46e5, #7c3aed);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .animate-float { animation: float 6s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    
    /* Bot칩n P치nico Pulsante */
    .panic-btn {
        box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7);
        animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(225, 29, 72, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); }
    }
</style>

<div id="printHeader" class="hidden print:block mb-8 border-b-2 border-indigo-600 pb-4">
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="text-4xl text-indigo-600"><i class="fas fa-brain"></i></div>
            <div><h1 class="text-2xl font-bold text-slate-900">MindCare Bolivia</h1><p class="text-sm text-slate-500">Reporte de Paciente</p></div>
        </div>
        <div class="text-right text-xs text-slate-400">
            <p>Generado por: <%= user.nombre %></p><p>Fecha: <span id="printDate"></span></p>
        </div>
    </div>
</div>

<div class="min-h-screen bg-slate-50 py-8 font-sans relative overflow-x-hidden">
    
    <div class="absolute top-0 left-0 w-full h-96 bg-gradient-to-b from-indigo-600 to-slate-50 -z-10"></div>
    <div class="absolute top-10 right-10 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float"></div>
    <div class="absolute top-10 left-10 w-64 h-64 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style="animation-delay: 2s"></div>

    <button onclick="triggerPanic()" class="fixed bottom-8 right-8 bg-rose-600 hover:bg-rose-700 text-white w-16 h-16 rounded-full flex items-center justify-center z-50 panic-btn border-4 border-white/20 transition-colors" title="Pedir Ayuda Urgente">
        <i class="fas fa-sos text-2xl font-bold"></i>
    </button>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" id="dashboardContent">
        
        <% if (locals.msg === 'alert_triggered') { %>
            <div class="mb-8 bg-white/90 backdrop-blur border-l-4 border-rose-500 p-6 rounded-xl shadow-lg animate-fade-in-down flex gap-4 items-start">
                <div class="bg-rose-100 p-3 rounded-full text-rose-600"><i class="fas fa-heart-broken text-xl"></i></div>
                <div>
                    <h3 class="font-bold text-rose-700 text-lg">Hemos detectado una alerta</h3>
                    <p class="text-slate-600">El sistema ha notificado autom치ticamente a tu terapeuta (<%= therapist ? 'Dr. '+therapist.apellido : 'Tu doctor' %>) y al equipo de crisis. Alguien te contactar치 pronto.</p>
                </div>
            </div>
        <% } %>

        <div class="flex flex-col md:flex-row justify-between items-end mb-10 gap-6 animate-fade-in-down">
            <div class="text-white">
                <p class="text-indigo-200 font-medium mb-1 uppercase tracking-wider text-xs">Panel Personal</p>
                <h1 class="text-4xl font-extrabold">Hola, <%= user.nombre %> 游녦</h1>
                <p class="text-indigo-100 mt-2 text-lg opacity-90">쮺칩mo te sientes hoy?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="exportExcel()" class="glass-card text-white px-4 py-2.5 rounded-xl font-bold text-sm hover:bg-white/20 transition flex items-center gap-2">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button onclick="generatePDF()" class="bg-white text-indigo-600 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-indigo-50 transition flex items-center gap-2 shadow-lg shadow-indigo-900/20">
                    <i class="fas fa-file-pdf"></i> Reporte PDF
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 relative z-10">
            <a href="/dashboard/monitoring" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-indigo-50 rounded-bl-full -mr-4 -mt-4 group-hover:bg-indigo-100 transition-colors"></div>
                <div class="relative z-10 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-indigo-600 text-white flex items-center justify-center text-xl shadow-lg shadow-indigo-500/30">
                        <i class="fas fa-heart-pulse"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg group-hover:text-indigo-600 transition-colors">Monitoreo</h3>
                        <p class="text-sm text-slate-500">Registra tu estado</p>
                    </div>
                </div>
            </a>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden cursor-default">
                <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 rounded-bl-full -mr-4 -mt-4 group-hover:bg-emerald-100 transition-colors"></div>
                <div class="relative z-10 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-emerald-500 text-white flex items-center justify-center text-xl shadow-lg shadow-emerald-500/30">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg">Mis Citas</h3>
                        <p class="text-sm text-slate-500">Pr칩xima: <%= nextAppointment ? new Date(nextAppointment.fecha_hora_inicio).toLocaleDateString() : 'Ninguna' %></p>
                    </div>
                </div>
            </div>

            <a href="/dashboard/communication" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-violet-50 rounded-bl-full -mr-4 -mt-4 group-hover:bg-violet-100 transition-colors"></div>
                <div class="relative z-10 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-violet-500 text-white flex items-center justify-center text-xl shadow-lg shadow-violet-500/30">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg group-hover:text-violet-600 transition-colors">Mensajes</h3>
                        <p class="text-sm text-slate-500">Chat con especialista</p>
                    </div>
                </div>
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-8">
                
                <div class="bg-white rounded-3xl shadow-lg border border-slate-100 p-8 relative overflow-hidden no-print">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">Diario Emocional</h3>
                            <p class="text-slate-500 text-sm">쯈u칠 tal tu d칤a hoy?</p>
                        </div>
                        <div class="bg-slate-50 px-3 py-1 rounded-lg text-xs font-bold text-slate-400 border border-slate-200">
                            <%= new Date().toLocaleDateString() %>
                        </div>
                    </div>

                    <form action="/dashboard/monitoring/checkin" method="POST" class="space-y-6">
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                            <div class="flex justify-between mb-2">
                                <label class="text-xs font-bold text-slate-500 uppercase">Nivel de 츼nimo</label>
                                <span id="valDisplay" class="text-sm font-bold text-indigo-600">3 - Normal</span>
                            </div>
                            <input type="range" name="valencia" min="1" max="5" value="3" class="w-full accent-indigo-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updateLabel(this.value)">
                            <div class="flex justify-between text-[10px] text-slate-400 mt-2 font-bold uppercase">
                                <span>Mal</span><span>Regular</span><span>Excelente</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="relative">
                                <i class="fas fa-smile absolute left-4 top-3.5 text-slate-400"></i>
                                <input type="text" name="emocion" placeholder="Emoci칩n (Ej: Ansioso)" class="w-full pl-10 p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" required>
                            </div>
                            <div class="relative">
                                <i class="fas fa-bed absolute left-4 top-3.5 text-slate-400"></i>
                                <input type="number" name="horas_sueno" placeholder="Horas de sue침o" class="w-full pl-10 p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                        </div>

                        <textarea name="notas" placeholder="Escribe tus pensamientos aqu칤..." class="w-full p-4 border border-slate-200 rounded-xl text-sm resize-none focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 focus:bg-white transition-colors" rows="2"></textarea>
                        
                        <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg transform hover:-translate-y-0.5">
                            Registrar Estado
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-8" id="chartContainer">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-800 text-lg">Evoluci칩n Semanal</h3>
                        <a href="/dashboard/monitoring" class="text-xs font-bold text-indigo-600 hover:bg-indigo-50 px-3 py-1.5 rounded-lg transition-colors">
                            Ver Detalle <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="patientChart"></canvas>
                    </div>
                </div>

            </div>

            <div class="space-y-8">
                
                <div class="bg-white rounded-3xl shadow-lg border border-slate-100 p-1 relative overflow-hidden">
                    <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-t-[20px] text-white relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-white/20 rounded-full blur-xl"></div>
                        <h3 class="font-bold text-lg relative z-10 flex items-center gap-2"><i class="fas fa-calendar-day"></i> Pr칩xima Sesi칩n</h3>
                    </div>
                    
                    <div class="p-6">
                        <% if (nextAppointment) { %>
                            <div class="text-center mb-6">
                                <p class="text-4xl font-black text-emerald-600 tracking-tighter mb-1">
                                    <%= new Date(nextAppointment.fecha_hora_inicio).getDate() %>
                                </p>
                                <p class="text-sm font-bold text-slate-500 uppercase tracking-widest">
                                    <%= new Date(nextAppointment.fecha_hora_inicio).toLocaleDateString('es-ES', {month:'long'}) %>
                                </p>
                                <div class="inline-block bg-slate-100 text-slate-600 text-sm font-bold px-3 py-1 rounded-lg mt-2 border border-slate-200">
                                    <i class="far fa-clock mr-1"></i> <%= new Date(nextAppointment.fecha_hora_inicio).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) %>
                                </div>
                            </div>
                            
                            <% if (nextAppointment.modalidad === 'Virtual' && nextAppointment.enlace_reunion) { %>
                                <a href="<%= nextAppointment.enlace_reunion %>" target="_blank" class="block w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-0.5 text-center">
                                    <i class="fas fa-video mr-2"></i> Unirse a Sala
                                </a>
                                <p class="text-[10px] text-center text-slate-400 mt-3">El enlace se activa 10 min antes.</p>
                            <% } else { %>
                                <div class="bg-slate-50 text-slate-500 py-3 rounded-xl text-center text-sm font-bold border border-slate-200">
                                    <i class="fas fa-map-marker-alt mr-2"></i> Consulta Presencial
                                </div>
                            <% } %>
                        <% } else { %>
                            <div class="text-center py-8">
                                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300 text-2xl">
                                    <i class="far fa-calendar"></i>
                                </div>
                                <p class="text-slate-400 text-sm font-medium">Sin citas programadas</p>
                                <a href="/dashboard/appointments" class="text-indigo-600 text-xs font-bold mt-2 hover:underline">Solicitar Cita</a>
                            </div>
                        <% } %>
                    </div>

                    <% if (pastAppointments.length > 0) { %>
                        <div class="border-t border-slate-100 bg-slate-50/50 p-4">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-3 pl-2">Historial Reciente</p>
                            <div class="space-y-2">
                                <% pastAppointments.forEach(past => { %>
                                    <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                        <div class="flex items-center gap-3">
                                            <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                                            <div>
                                                <p class="text-xs font-bold text-slate-700"><%= new Date(past.fecha_hora_inicio).toLocaleDateString() %></p>
                                                <p class="text-[10px] text-slate-400">Dr. <%= past.doc_apellido %></p>
                                            </div>
                                        </div>
                                        <span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded"><%= past.estado %></span>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>
                </div>

                <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-3xl p-6 border border-orange-100">
                    <h2 class="text-sm font-bold text-orange-800 mb-4 flex items-center uppercase tracking-wide">
                        <i class="fas fa-clipboard-list mr-2"></i> Pendientes
                    </h2>
                    <div class="space-y-3">
                        <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center hover:shadow-md transition-all cursor-pointer border border-transparent hover:border-orange-200">
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">Test PHQ-9</h3>
                                <p class="text-[10px] text-slate-500">Evaluaci칩n de Depresi칩n</p>
                            </div>
                            <a href="/dashboard/test/phq9" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm shadow-orange-200">Iniciar</a>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center hover:shadow-md transition-all cursor-pointer border border-transparent hover:border-orange-200">
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">Test GAD-7</h3>
                                <p class="text-xs text-slate-500">Evaluaci칩n de Ansiedad</p>
                            </div>
                            <a href="/dashboard/test/gad7" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm shadow-orange-200">Iniciar</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // DATA
    const rawData = '<%- JSON.stringify(checkins || []) %>';
    const data = JSON.parse(rawData).reverse();

    // CHART (Minimalist)
    const ctx = document.getElementById('patientChart');
    if (ctx && data.length > 0) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => new Date(d.fecha_hora).toLocaleDateString('es-ES', {day:'2-digit', month:'short'})),
                datasets: [{
                    label: 'Nivel',
                    data: data.map(d => d.valencia),
                    borderColor: '#6366f1',
                    backgroundColor: (context) => {
                        const ctx = context.chart.ctx;
                        const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.2)');
                        gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');
                        return gradient;
                    },
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#6366f1',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { 
                    y: { min: 1, max: 5, grid: { borderDash: [4, 4] }, ticks: { font: { size: 10 } } },
                    x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                } 
            }
        });
    }

    // HELPER: EXPORT PDF
    function generatePDF() {
        document.getElementById('printDate').innerText = new Date().toLocaleString();
        const element = document.body; 
        const opt = {
            margin: 0,
            filename: 'Mi_Reporte_MindCare.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    // HELPER: EXPORT EXCEL
    function exportExcel() {
        const wb = XLSX.utils.book_new();
        const wsData = [
            ["Fecha", "Hora", "Nivel 츼nimo", "Emoci칩n", "Sue침o (h)", "Notas"],
            ...data.map(d => [
                new Date(d.fecha_hora).toLocaleDateString(),
                new Date(d.fecha_hora).toLocaleTimeString(),
                d.valencia,
                d.emocion_principal,
                d.horas_sueno,
                d.notas
            ])
        ];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Historial");
        XLSX.writeFile(wb, "Mi_Historial_MindCare.xlsx");
    }

    // HELPER: PANIC BUTTON
    function triggerPanic() {
        if(confirm("쮸CTIVAR ALERTA DE EMERGENCIA?\n\nSe notificar치 inmediatamente a tu doctor y al equipo de crisis.")) {
            fetch('/dashboard/monitoring/panic', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert("游뚿 AYUDA EN CAMINO. Mant칠n la calma, el equipo ha sido notificado.");
                })
                .catch(err => alert("Error de conexi칩n. Llama al 110."));
        }
    }

    function updateLabel(v) {
        const l = {1:'P칠simo', 2:'Mal', 3:'Normal', 4:'Bien', 5:'Excelente'};
        document.getElementById('valDisplay').innerText = v + ' - ' + (l[v]||'');
        
        // Cambio de color din치mico
        const display = document.getElementById('valDisplay');
        if(v <= 2) display.className = "text-sm font-bold text-rose-600";
        else if(v == 3) display.className = "text-sm font-bold text-amber-500";
        else display.className = "text-sm font-bold text-emerald-600";
    }
</script>

<%- include('../partials/footer') %>