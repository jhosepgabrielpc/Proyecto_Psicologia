<%- include('../partials/header', { title: 'Mi Espacio - MindCare' }) %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<style>
    /* === LAYOUT FIX: STICKY FOOTER === */
    body { margin: 0; padding: 0; }
    .app-wrapper {
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* Ocupa al menos toda la pantalla */
    }
    .app-content {
        flex: 1; /* Empuja el footer hacia abajo si hay poco contenido */
        position: relative;
        z-index: 10;
    }

    /* === ESTILOS VISUALES === */
    .glass-effect {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* BotÃ³n PÃ¡nico Pulsante */
    .panic-btn-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 100; }
    .panic-btn {
        background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
        color: white; width: 4rem; height: 4rem;
        border-radius: 9999px; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 10px 20px rgba(220, 38, 38, 0.4);
        animation: pulse-red 2s infinite; border: 4px solid rgba(255,255,255,0.3);
        transition: transform 0.2s;
    }
    .panic-btn:hover { transform: scale(1.1); background: #dc2626; }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    /* Input Range Moderno */
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%;
        background: #4f46e5; cursor: pointer; margin-top: -12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 3px solid white; transition: transform 0.1s;
    }
    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.15); }
    input[type=range]::-webkit-slider-runnable-track {
        width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 99px;
    }
</style>

<div class="app-wrapper bg-slate-50 font-sans">

    <div class="app-content relative">
        
        <div class="absolute inset-0 -z-10 overflow-hidden pointer-events-none">
            <div class="absolute top-0 left-0 right-0 h-[600px] bg-gradient-to-b from-indigo-100/60 via-white/20 to-slate-50"></div>
            <div class="absolute top-[-100px] right-[-100px] w-[600px] h-[600px] bg-purple-200/30 rounded-full mix-blend-multiply filter blur-[100px] opacity-60"></div>
            <div class="absolute top-[200px] left-[-100px] w-[500px] h-[500px] bg-blue-200/30 rounded-full mix-blend-multiply filter blur-[100px] opacity-60"></div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" id="dashboardContent">

            <div class="flex flex-col md:flex-row justify-between items-end gap-6 mb-12 animate-fade-in-down">
                <div>
                    <div class="inline-flex items-center gap-2 px-3 py-1 bg-white/80 backdrop-blur rounded-full border border-indigo-100 shadow-sm mb-3">
                        <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                        <span class="text-[10px] font-black text-indigo-600 uppercase tracking-widest">
                            <%= new Date().toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'}) %>
                        </span>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tight">
                        Hola, <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600"><%= user.nombre %></span> ðŸ‘‹
                    </h1>
                    <p class="text-slate-500 mt-2 text-lg max-w-2xl">
                        Tu espacio seguro para sanar y crecer. Â¿CÃ³mo te sientes hoy?
                    </p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="exportExcel()" class="bg-white text-slate-700 px-5 py-3 rounded-xl font-bold text-sm hover:bg-slate-50 transition border border-slate-200 shadow-sm hover:shadow-md flex items-center gap-2">
                        <i class="fas fa-file-excel text-emerald-600 text-lg"></i> <span class="hidden sm:inline">Excel</span>
                    </button>
                    <button onclick="generatePDF()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center gap-2 transform hover:-translate-y-0.5">
                        <i class="fas fa-file-pdf"></i> <span class="hidden sm:inline">Reporte</span>
                    </button>
                </div>
            </div>

            <% if (locals.msg) { %>
                <div class="mb-10 p-5 rounded-2xl shadow-sm border animate-fade-in flex gap-5 items-center relative overflow-hidden
                    <%= msg.includes('alert') ? 'bg-rose-50 border-rose-100' : 'bg-emerald-50 border-emerald-100' %>">
                    <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
                        <i class="fas <%= msg.includes('alert') ? 'fa-exclamation-triangle' : 'fa-check-circle' %> text-8xl"></i>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center flex-shrink-0 <%= msg.includes('alert') ? 'bg-rose-100 text-rose-600' : 'bg-emerald-100 text-emerald-600' %>">
                        <i class="fas <%= msg.includes('alert') ? 'fa-heart-broken' : 'fa-check' %> text-xl"></i>
                    </div>
                    <div class="z-10">
                        <h3 class="font-bold text-slate-800 text-lg"><%= msg.includes('alert') ? 'Alerta Registrada' : 'OperaciÃ³n Exitosa' %></h3>
                        <p class="text-sm text-slate-600 mt-0.5">
                            <% if(msg === 'checkin_saved') { %> Tu registro diario se ha guardado correctamente. Â¡Gracias por compartir! <% } %>
                            <% if(msg === 'alert_triggered') { %> El sistema ha notificado a tu terapeuta. MantÃ©n la calma, te contactarÃ¡n pronto. <% } %>
                        </p>
                    </div>
                </div>
            <% } %>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 space-y-8">
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <a href="#monitor-section" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:border-indigo-200 hover:shadow-md transition-all group relative overflow-hidden card-hover">
                            <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-heart-pulse"></i>
                            </div>
                            <h3 class="font-bold text-slate-800">Check-in</h3>
                            <p class="text-xs text-slate-500 mt-1 font-medium">Registrar estado</p>
                        </a>

                        <a href="/dashboard/appointments" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:border-emerald-200 hover:shadow-md transition-all group relative overflow-hidden card-hover">
                            <div class="w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-video"></i>
                            </div>
                            <h3 class="font-bold text-slate-800">Mis Citas</h3>
                            <p class="text-xs text-slate-500 mt-1 font-medium">Ver agenda</p>
                        </a>

                        <a href="/dashboard/communication" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:border-violet-200 hover:shadow-md transition-all group relative overflow-hidden card-hover">
                            <div class="w-12 h-12 rounded-2xl bg-violet-50 text-violet-600 flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="far fa-comments"></i>
                            </div>
                            <h3 class="font-bold text-slate-800">Mensajes</h3>
                            <p class="text-xs text-slate-500 mt-1 font-medium">Chat seguro</p>
                        </a>
                    </div>

                    <div id="monitor-section" class="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
                        <div class="p-8 pb-0 flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-extrabold text-slate-800">Diario Emocional</h2>
                                <p class="text-slate-500 text-sm mt-1">Registra tus emociones para mejorar tu seguimiento.</p>
                            </div>
                            <div class="bg-indigo-50 p-3 rounded-full">
                                <i class="fas fa-feather-alt text-indigo-400 text-2xl"></i>
                            </div>
                        </div>
                        
                        <div class="p-8">
                            <form action="/dashboard/monitoring/checkin" method="POST" class="space-y-8">
                                
                                <div class="bg-slate-50/80 p-6 rounded-2xl border border-slate-200">
                                    <div class="flex justify-between items-center mb-6">
                                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Â¿CÃ³mo te sientes?</label>
                                        <span id="valDisplay" class="text-sm font-bold text-indigo-700 bg-white px-4 py-1.5 rounded-lg shadow-sm border border-indigo-100">3 - Normal</span>
                                    </div>
                                    <div class="relative h-10 flex items-center px-2">
                                        <div class="absolute w-full h-3 bg-slate-200 rounded-full overflow-hidden">
                                            <div class="h-full w-full bg-gradient-to-r from-rose-300 via-indigo-300 to-emerald-300 opacity-60"></div>
                                        </div>
                                        <input type="range" name="valencia" min="1" max="5" value="3" step="1" oninput="updateLabel(this.value)" class="relative z-10 w-full">
                                    </div>
                                    <div class="flex justify-between text-[10px] text-slate-400 font-bold uppercase mt-3 px-1">
                                        <span>Mal</span><span>Regular</span><span>Excelente</span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">EmociÃ³n Principal</label>
                                        <div class="relative group">
                                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                                <i class="far fa-smile text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                                            </div>
                                            <input type="text" name="emocion" placeholder="Ej: Ansioso, Feliz..." required
                                                class="w-full pl-11 pr-4 py-3.5 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm transition-all">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">SueÃ±o (Horas)</label>
                                        <div class="relative group">
                                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                                <i class="fas fa-bed text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                                            </div>
                                            <input type="number" name="horas_sueno" placeholder="0" min="0" max="24"
                                                class="w-full pl-11 pr-4 py-3.5 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm transition-all">
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Notas Adicionales</label>
                                    <textarea name="notas" rows="3" placeholder="Escribe aquÃ­ tus pensamientos..."
                                        class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm transition-all"></textarea>
                                </div>

                                <button type="submit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-800 hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-3">
                                    <span>Guardar Registro</span> <i class="fas fa-arrow-right"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-8 relative">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <span class="w-1 h-6 bg-indigo-500 rounded-full"></span> Tu EvoluciÃ³n
                            </h3>
                            <a href="/dashboard/monitoring" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-lg hover:bg-indigo-100 transition-colors">
                                Ver Detalles
                            </a>
                        </div>
                        
                        <div id="chartData" data-checkins='<%- JSON.stringify(checkins || []) %>' style="display:none;"></div>
                        
                        <div class="relative h-64 w-full">
                            <canvas id="patientChart"></canvas>
                        </div>
                    </div>

                </div>

                <div class="lg:col-span-1 space-y-8">
                    
                    <div class="bg-slate-900 rounded-3xl shadow-2xl p-1 relative overflow-hidden group hover:transform hover:scale-[1.02] transition-all duration-300">
                        <div class="absolute -top-20 -right-20 w-64 h-64 bg-indigo-600 rounded-full mix-blend-overlay filter blur-3xl opacity-30"></div>
                        <div class="absolute bottom-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        
                        <div class="bg-slate-900 rounded-[20px] p-6 relative h-full flex flex-col">
                            <div class="flex justify-between items-start mb-6">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">PrÃ³xima SesiÃ³n</h3>
                                <div class="bg-white/10 p-2 rounded-lg"><i class="far fa-calendar text-white"></i></div>
                            </div>

                            <% if (nextAppointment) { %>
                                <div class="flex-1">
                                    <div class="text-center my-4">
                                        <span class="text-6xl font-black text-white tracking-tighter"><%= new Date(nextAppointment.fecha_hora_inicio).getDate() %></span>
                                        <p class="text-lg font-medium text-indigo-200 uppercase mt-[-5px]">
                                            <%= new Date(nextAppointment.fecha_hora_inicio).toLocaleDateString('es-ES', {month:'short'}) %>
                                        </p>
                                        <div class="inline-flex items-center gap-2 bg-white/10 px-4 py-1.5 rounded-full mt-4 text-sm font-bold border border-white/10 text-white">
                                            <i class="far fa-clock"></i> <%= new Date(nextAppointment.fecha_hora_inicio).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) %>
                                        </div>
                                    </div>
                                </div>

                                <% if (nextAppointment.modalidad === 'Virtual' && nextAppointment.enlace_reunion) { %>
                                    <a href="<%= nextAppointment.enlace_reunion %>" target="_blank" class="block w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl text-center shadow-lg shadow-indigo-900/50 transition-all mt-4">
                                        <i class="fas fa-video mr-2"></i> Unirse a Sala
                                    </a>
                                <% } else { %>
                                    <div class="w-full bg-white/5 border border-white/10 text-slate-300 font-bold py-3 rounded-xl text-center text-sm mt-4">
                                        <i class="fas fa-building mr-2"></i> Presencial
                                    </div>
                                <% } %>
                            <% } else { %>
                                <div class="flex-1 flex flex-col items-center justify-center text-center py-6">
                                    <i class="far fa-calendar-times text-4xl text-slate-700 mb-3"></i>
                                    <p class="text-slate-400 text-sm mb-6">No tienes citas programadas.</p>
                                    <a href="/dashboard/appointments" class="block w-full bg-white text-slate-900 font-bold py-3 rounded-xl text-center hover:bg-slate-100 transition-colors">
                                        Agendar Cita
                                    </a>
                                </div>
                            <% } %>
                        </div>
                    </div>

                    <% if (therapist) { %>
                        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 flex items-center gap-4">
                            <img src="<%= therapist.foto || 'https://ui-avatars.com/api/?name='+therapist.nombre+'+'+therapist.apellido+'&background=6366f1&color=fff' %>" class="w-16 h-16 rounded-2xl object-cover shadow-sm border border-slate-100">
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Tu Especialista</p>
                                <h4 class="font-bold text-slate-900 text-base">Dr. <%= therapist.apellido %></h4>
                                <a href="/dashboard/communication" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 flex items-center gap-1 mt-1 transition-colors">
                                    <i class="far fa-comment-dots"></i> Enviar mensaje
                                </a>
                            </div>
                        </div>
                    <% } %>

                    <div class="bg-gradient-to-b from-amber-50 to-white rounded-3xl border border-amber-100 p-6">
                        <h3 class="text-xs font-bold text-amber-800 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <i class="fas fa-tasks"></i> Pendientes
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-xl border border-amber-100 shadow-sm flex justify-between items-center group hover:border-amber-300 transition-colors">
                                <div>
                                    <p class="font-bold text-slate-800 text-sm">Test PHQ-9</p>
                                    <p class="text-[10px] text-slate-400">DepresiÃ³n</p>
                                </div>
                                <a href="/dashboard/test/phq9" class="bg-amber-100 text-amber-700 hover:bg-amber-500 hover:text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors">Iniciar</a>
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-amber-100 shadow-sm flex justify-between items-center group hover:border-amber-300 transition-colors">
                                <div>
                                    <p class="font-bold text-slate-800 text-sm">Test GAD-7</p>
                                    <p class="text-[10px] text-slate-400">Ansiedad</p>
                                </div>
                                <a href="/dashboard/test/gad7" class="bg-amber-100 text-amber-700 hover:bg-amber-500 hover:text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors">Iniciar</a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <footer class="bg-slate-900 text-white mt-auto border-t border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-12">
                <div class="col-span-1 md:col-span-1">
                    <h3 class="text-2xl font-extrabold mb-4 flex items-center tracking-tight text-white">
                        <i class="fas fa-brain text-indigo-500 mr-2 text-3xl"></i> MindCare
                    </h3>
                    <p class="text-slate-400 text-sm leading-relaxed">
                        Revolucionando la salud mental con tecnologÃ­a accesible. Teleterapia segura, monitoreo emocional y apoyo profesional.
                    </p>
                </div>
                <div>
                    <h4 class="font-bold text-slate-200 uppercase text-xs tracking-wider mb-4">Plataforma</h4>
                    <ul class="space-y-3 text-sm font-medium text-slate-400">
                        <li><a href="/dashboard" class="hover:text-indigo-400 transition-colors">Inicio</a></li>
                        <li><a href="/dashboard/appointments" class="hover:text-indigo-400 transition-colors">Citas</a></li>
                        <li><a href="/dashboard/communication" class="hover:text-indigo-400 transition-colors">Mensajes</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-slate-200 uppercase text-xs tracking-wider mb-4">Soporte</h4>
                    <ul class="space-y-3 text-sm font-medium text-slate-400">
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">Centro de Ayuda</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">Privacidad y Datos</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">TÃ©rminos de Uso</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-slate-200 uppercase text-xs tracking-wider mb-4">Contacto</h4>
                    <ul class="space-y-3 text-sm text-slate-400">
                        <li class="flex items-start"><i class="fas fa-map-marker-alt mt-1 mr-3 text-indigo-500"></i><span>La Paz, Bolivia</span></li>
                        <li class="flex items-center"><i class="fas fa-phone-alt mr-3 text-indigo-500"></i><span>+591 2 1234567</span></li>
                        <li class="flex items-center"><i class="fas fa-envelope mr-3 text-indigo-500"></i><span>info@mindcare.bo</span></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-slate-800 pt-8 flex flex-col md:flex-row justify-between items-center text-xs text-slate-500">
                <p>&copy; <%= new Date().getFullYear() %> MindCare Bolivia. Todos los derechos reservados.</p>
                <div class="mt-2 md:mt-0">Desarrollado con <i class="fas fa-heart text-rose-500 mx-1"></i> por el Equipo MindCare</div>
            </div>
        </div>
    </footer>

    <div class="panic-btn-container">
        <button onclick="triggerPanic()" class="panic-btn" title="SOLICITAR AYUDA URGENTE">
            <i class="fas fa-exclamation text-xl font-bold"></i>
        </button>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CHARTS ---
        try {
            const rawData = document.getElementById('chartData').getAttribute('data-checkins');
            const data = JSON.parse(rawData).reverse();
            
            const ctx = document.getElementById('patientChart');
            if (ctx) {
                if (data.length > 0) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => new Date(d.fecha_hora).toLocaleDateString('es-ES', {weekday: 'short'})),
                            datasets: [{
                                label: 'Nivel',
                                data: data.map(d => d.valencia),
                                borderColor: '#6366f1',
                                borderWidth: 3,
                                backgroundColor: (context) => {
                                    const ctx = context.chart.ctx;
                                    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                                    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
                                    gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');
                                    return gradient;
                                },
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#6366f1',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { min: 1, max: 5, grid: { borderDash: [8, 8], color: '#f1f5f9' }, ticks: { display: false } },
                                x: { grid: { display: false }, ticks: { font: { family: "'Inter', sans-serif", size: 11 }, color: '#94a3b8' } }
                            }
                        }
                    });
                } else {
                    ctx.parentNode.innerHTML = '<div class="h-full flex items-center justify-center text-slate-300 font-medium">Sin datos suficientes</div>';
                }
            }
        } catch(e) { console.error("Error graficando:", e); }
    });

    window.updateLabel = function(v) {
        const labels = {1: 'PÃ©simo', 2: 'Mal', 3: 'Normal', 4: 'Bien', 5: 'Excelente'};
        const colors = {1: 'text-rose-600', 2: 'text-orange-500', 3: 'text-indigo-600', 4: 'text-blue-500', 5: 'text-emerald-600'};
        const display = document.getElementById('valDisplay');
        display.innerText = `${v} - ${labels[v]}`;
        display.className = `text-sm font-bold bg-white px-3 py-1.5 rounded-lg shadow-sm border border-slate-100 ${colors[v]}`;
    }

    window.triggerPanic = function() {
        if(confirm("âš  ALERTA DE EMERGENCIA\n\nÂ¿Necesitas ayuda inmediata? Esto notificarÃ¡ a todo el equipo mÃ©dico.")) {
            fetch('/dashboard/monitoring/panic', { method: 'POST' })
                .then(res => res.json())
                .then(() => {
                    alert("ðŸš¨ ALERTA ENVIADA. La ayuda estÃ¡ en camino.");
                    window.location.reload();
                })
                .catch(() => alert("Error de conexiÃ³n. Llama al 110."));
        }
    }

    window.generatePDF = function() { alert("Generando PDF detallado..."); }
    window.exportExcel = function() { alert("Generando Excel..."); }
</script>