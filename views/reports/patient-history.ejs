<%- include('../partials/header', { title: 'Expediente Clínico' }) %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    @media print {
        .no-print { display: none !important; }
        .print-break { page-break-inside: avoid; }
        body { background: white; }
        .shadow-sm { border: 1px solid #ddd; }
    }
    .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; }
    .tab-inactive { color: #64748b; }
</style>

<div class="min-h-screen bg-slate-50 py-8 font-sans">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <nav class="flex mb-6 text-sm font-medium text-slate-500 no-print">
            <a href="/dashboard" class="hover:text-indigo-600"><i class="fas fa-home mr-2"></i>Inicio</a>
            <span class="mx-2">/</span>
            <a href="/reports/history" class="hover:text-indigo-600">Historiales</a>
            <span class="mx-2">/</span>
            <span class="text-indigo-600 font-bold">#<%= patient.id_paciente %></span>
        </nav>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 no-print">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900">Expediente Clínico</h1>
                <p class="text-slate-500 text-sm mt-1">Gestión integral y seguimiento.</p>
            </div>
            <div class="flex gap-3">
                <a href="/reports/patient/<%= patient.id_paciente %>/create-report" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow hover:bg-indigo-700 transition flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i> Nuevo Reporte
                </a>
                <button onclick="window.print()" class="bg-white text-slate-600 border border-slate-200 px-4 py-2 rounded-xl font-bold hover:bg-slate-50 transition shadow-sm">
                    <i class="fas fa-print mr-2"></i> PDF
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 ">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden print-break">
                    <div class="h-24 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
                    <div class="px-6 pb-6 relative">
                        <div class="flex flex-col items-start -mt-10 mb-4">
                            <% if (patient.foto_perfil) { %>
                                <img src="<%= patient.foto_perfil %>" class="h-20 w-20 rounded-2xl border-4 border-white shadow-md bg-white object-cover">
                            <% } else { %>
                                <div class="h-20 w-20 rounded-2xl bg-white border-4 border-white shadow-md flex items-center justify-center text-2xl font-bold text-indigo-600 bg-indigo-50">
                                    <%= patient.nombre.charAt(0) %><%= patient.apellido.charAt(0) %>
                                </div>
                            <% } %>
                            
                            <div class="mt-3">
                                <h2 class="text-xl font-bold text-slate-900"><%= patient.nombre %> <%= patient.apellido %></h2>
                                <span class="inline-block px-2 py-0.5 rounded text-xs font-bold uppercase mt-1 <%= patient.estado_tratamiento === 'activo' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600' %>">
                                    <%= patient.estado_tratamiento %>
                                </span>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-slate-100 space-y-2 text-sm text-slate-600">
                            <p><i class="fas fa-envelope w-5 text-slate-400"></i> <%= patient.email %></p>
                            <p><i class="fas fa-phone w-5 text-slate-400"></i> <%= patient.telefono || 'Sin teléfono' %></p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-100 print-break">
                    <h3 class="font-bold text-slate-900 mb-4">Documentos</h3>
                    <% if (reports && reports.length > 0) { %>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            <% reports.forEach(r => { %>
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg hover:bg-indigo-50 transition cursor-pointer" 
                                     onclick="openReportModal('<%= r.tipo_reporte %>', '<%= new Date(r.fecha_generacion).toLocaleDateString() %>', `<%= r.resumen_evolucion %>`)">
                                    <div>
                                        <p class="text-sm font-bold text-slate-700"><%= r.tipo_reporte %></p>
                                        <p class="text-xs text-slate-400"><%= new Date(r.fecha_generacion).toLocaleDateString() %></p>
                                    </div>
                                    <i class="fas fa-eye text-slate-400"></i>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p class="text-xs text-slate-400 text-center">Sin reportes.</p>
                    <% } %>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                
                <div class="border-b border-slate-200 flex gap-6 no-print">
                    <button onclick="switchTab('timeline')" id="tab-timeline" class="tab-active pb-3 px-1 text-sm font-bold transition-colors">
                        <i class="fas fa-stream mr-1"></i> Línea de Tiempo
                    </button>
                    <button onclick="switchTab('evolution')" id="tab-evolution" class="tab-inactive pb-3 px-1 text-sm font-bold transition-colors">
                        <i class="fas fa-chart-line mr-1"></i> Gráficas de Evolución
                    </button>
                </div>

                <div id="view-timeline" class="space-y-8">
                    <div class="relative border-l-2 border-slate-200 ml-4 space-y-8 pl-8 pb-4">
                        <% if (sessions && sessions.length > 0) { %>
                            <% sessions.forEach(session => { %>
                                <div class="relative print-break">
                                    <span class="absolute -left-[41px] top-0 h-5 w-5 rounded-full border-4 border-white shadow-sm z-10 <%= session.calidad_sesion === 'excelente' ? 'bg-emerald-500' : 'bg-indigo-500' %>"></span>
                                    
                                    <div class="flex items-center mb-2 gap-3">
                                        <span class="text-xs font-bold text-slate-500"><%= new Date(session.fecha_hora_inicio).toLocaleDateString() %></span>
                                        <span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded"><%= session.tipo_consulta %></span>
                                    </div>

                                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition-all">
                                        <div class="flex justify-between items-start mb-3">
                                            <h4 class="font-bold text-slate-800">Nota Clínica</h4>
                                            <button onclick="openSOAPModal('<%= session.id_cita %>', `<%= session.notas_terapeuta %>`)" class="text-slate-400 hover:text-indigo-600 no-print" title="Editar Nota SOAP">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                        </div>
                                        
                                        <div class="space-y-3 text-sm text-slate-600 leading-relaxed">
                                            <% if (session.notas_terapeuta) { %>
                                                <div class="whitespace-pre-line bg-slate-50 p-3 rounded-lg border-l-4 border-indigo-200">
                                                    <%= session.notas_terapeuta %>
                                                </div>
                                            <% } else { %>
                                                <p class="italic text-slate-400">Sin nota registrada.</p>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p class="text-slate-400 italic ml-2">No hay sesiones registradas.</p>
                        <% } %>
                    </div>
                </div>

                <div id="view-evolution" class="hidden space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4">Estado de Ánimo (Check-ins)</h3>
                        <div class="h-64 w-full"><canvas id="chartEmociones"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4">Resultados Psicométricos</h3>
                        <div class="h-64 w-full"><canvas id="chartTests"></canvas></div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="soapModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 no-print">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all">
        <div class="px-6 py-4 bg-indigo-600 text-white flex justify-between items-center rounded-t-2xl">
            <h3 class="font-bold">Nota SOAP</h3>
            <button onclick="closeModal('soapModal')"><i class="fas fa-times"></i></button>
        </div>
        <form action="/reports/session/update" method="POST" class="p-6 space-y-4">
            <input type="hidden" name="sessionId" id="soapSessionId">
            <input type="hidden" name="patientId" value="<%= patient.id_paciente %>">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">S - Subjetivo</label>
                    <textarea id="soapS" rows="3" class="w-full rounded border-slate-200 text-sm bg-slate-50"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">O - Objetivo</label>
                    <textarea id="soapO" rows="3" class="w-full rounded border-slate-200 text-sm bg-slate-50"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">A - Análisis</label>
                    <textarea id="soapA" rows="3" class="w-full rounded border-slate-200 text-sm bg-slate-50"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">P - Plan</label>
                    <textarea id="soapP" rows="3" class="w-full rounded border-slate-200 text-sm bg-slate-50"></textarea>
                </div>
            </div>
            <input type="hidden" name="notas" id="finalNotes">
            <div class="flex justify-end pt-2">
                <button type="submit" onclick="combineSOAP()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div id="reportModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 no-print">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6">
        <h3 class="text-xl font-bold text-slate-900 mb-1" id="repTitle">Reporte</h3>
        <p class="text-sm text-slate-500 mb-4" id="repDate">Fecha</p>
        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-sm text-slate-700 mb-6 max-h-60 overflow-y-auto" id="repContent"></div>
        <div class="flex justify-end">
            <button onclick="closeModal('reportModal')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold">Cerrar</button>
        </div>
    </div>
</div>

<script>
    // Tabs
    function switchTab(tab) {
        document.getElementById('view-timeline').classList.add('hidden');
        document.getElementById('view-evolution').classList.add('hidden');
        document.getElementById('tab-timeline').className = 'tab-inactive pb-3 px-1 text-sm font-bold transition-colors';
        document.getElementById('tab-evolution').className = 'tab-inactive pb-3 px-1 text-sm font-bold transition-colors';
        
        document.getElementById('view-' + tab).classList.remove('hidden');
        document.getElementById('tab-' + tab).className = 'tab-active pb-3 px-1 text-sm font-bold transition-colors';
    }

    // Modales
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    
    function openReportModal(type, date, content) {
        document.getElementById('repTitle').innerText = 'Reporte ' + type;
        document.getElementById('repDate').innerText = date;
        document.getElementById('repContent').innerText = content;
        document.getElementById('reportModal').classList.remove('hidden');
    }

    function openSOAPModal(sid, notes) {
        document.getElementById('soapSessionId').value = sid;
        // Parsear notas simples
        const sMatch = notes.match(/S:\s*(.*?)(?=\nO:|$)/s);
        const oMatch = notes.match(/O:\s*(.*?)(?=\nA:|$)/s);
        const aMatch = notes.match(/A:\s*(.*?)(?=\nP:|$)/s);
        const pMatch = notes.match(/P:\s*(.*)/s);

        document.getElementById('soapS').value = sMatch ? sMatch[1].trim() : (notes.includes('S:') ? '' : notes);
        document.getElementById('soapO').value = oMatch ? oMatch[1].trim() : '';
        document.getElementById('soapA').value = aMatch ? aMatch[1].trim() : '';
        document.getElementById('soapP').value = pMatch ? pMatch[1].trim() : '';
        document.getElementById('soapModal').classList.remove('hidden');
    }

    function combineSOAP() {
        const s = document.getElementById('soapS').value;
        const o = document.getElementById('soapO').value;
        const a = document.getElementById('soapA').value;
        const p = document.getElementById('soapP').value;
        document.getElementById('finalNotes').value = `S: ${s}\nO: ${o}\nA: ${a}\nP: ${p}`;
    }

    // Gráficas
    document.addEventListener('DOMContentLoaded', function() {
        // CORRECCIÓN AQUÍ: Usamos las variables directas, no graphData
        const rawCheckins = '<%- JSON.stringify(checkins || []) %>';
        const rawTests = '<%- JSON.stringify(tests || []) %>';
        const checkins = JSON.parse(rawCheckins);
        const tests = JSON.parse(rawTests);

        if (checkins.length > 0) {
            new Chart(document.getElementById('chartEmociones'), {
                type: 'line',
                data: {
                    labels: checkins.map(c => new Date(c.fecha_hora).toLocaleDateString()),
                    datasets: [{ label: 'Nivel de Ánimo', data: checkins.map(c => c.valencia), borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 1, max: 5 } } }
            });
        }

        if (tests.length > 0) {
            new Chart(document.getElementById('chartTests'), {
                type: 'bar',
                data: {
                    labels: tests.map(t => `${t.nombre_escala} (${new Date(t.fecha_completacion).toLocaleDateString()})`),
                    datasets: [{ label: 'Puntaje', data: tests.map(t => t.puntuacion_total), backgroundColor: '#10b981' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    });
</script>

<%- include('../partials/footer') %>