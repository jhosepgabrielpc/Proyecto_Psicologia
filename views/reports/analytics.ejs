<%- include('../partials/header', { title: 'Analytics' }) %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    @media print {
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        body { background-color: white; }
        .shadow-sm, .shadow-md { box-shadow: none !important; }
    }
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 bg-gray-50 min-h-screen">
    
    <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Analytics & Reportes </h1>
            <p class="text-gray-600 mt-1">M茅tricas y estad铆sticas de la plataforma</p>
        </div>
        
        <div class="flex gap-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm no-print">
            <% const p = period || 'all'; %>
            <a href="/reports/analytics?period=week" 
               class="px-3 py-1 text-sm font-medium rounded-md transition-colors <%= p === 'week' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100' %>">
               Semana
            </a>
            <a href="/reports/analytics?period=month" 
               class="px-3 py-1 text-sm font-medium rounded-md transition-colors <%= p === 'month' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100' %>">
               Mes
            </a>
            <a href="/reports/analytics?period=year" 
               class="px-3 py-1 text-sm font-medium rounded-md transition-colors <%= p === 'year' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100' %>">
               A帽o
            </a>
            <a href="/reports/analytics" 
               class="px-3 py-1 text-sm font-medium rounded-md transition-colors <%= p === 'all' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100' %>">
               Hist贸rico
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Usuarios Nuevos</p>
                    <p class="text-2xl font-bold text-gray-900"><%= stats.usuarios %></p>
                </div>
                <div class="bg-blue-100 p-3 rounded-lg">
                    <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-blue-600 mt-2 bg-blue-50 inline-block px-2 py-0.5 rounded-full font-medium">
                <i class="fas fa-filter mr-1"></i> Filtro: <%= period === 'all' ? 'Hist贸rico' : period %>
            </p>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Citas Completadas</p>
                    <p class="text-2xl font-bold text-gray-900"><%= stats.citas %></p>
                </div>
                <div class="bg-green-100 p-3 rounded-lg">
                    <i class="fas fa-calendar-check text-green-600 text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-green-600 mt-2 bg-green-50 inline-block px-2 py-0.5 rounded-full font-medium">
                <i class="fas fa-check mr-1"></i> Finalizadas
            </p>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Check-ins</p>
                    <p class="text-2xl font-bold text-gray-900"><%= stats.checkins %></p>
                </div>
                <div class="bg-purple-100 p-3 rounded-lg">
                    <i class="fas fa-heart text-purple-600 text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-purple-600 mt-2 bg-purple-50 inline-block px-2 py-0.5 rounded-full font-medium">
                <i class="fas fa-chart-line mr-1"></i> Registros
            </p>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Pacientes Activos</p>
                    <p class="text-2xl font-bold text-gray-900"><%= stats.pacientes_activos %></p>
                </div>
                <div class="bg-red-100 p-3 rounded-lg">
                    <i class="fas fa-user-injured text-red-600 text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-red-600 mt-2 bg-red-50 inline-block px-2 py-0.5 rounded-full font-medium">
                <i class="fas fa-heartbeat mr-1"></i> En tratamiento
            </p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 break-inside-avoid">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Resumen de Actividad</h3>
            <div class="relative h-64 w-full">
                <canvas id="activityChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 break-inside-avoid">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Distribuci贸n de Datos</h3>
            <div class="relative h-64 w-full flex justify-center">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 no-print">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Centro de Exportaci贸n</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <button onclick="window.print()" class="flex items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition group cursor-pointer">
                <div class="bg-red-50 p-2 rounded-lg group-hover:bg-red-100 transition">
                    <i class="fas fa-file-pdf text-red-600 text-xl"></i>
                </div>
                <div class="text-left ml-3">
                    <p class="font-bold text-gray-800">Imprimir Reporte</p>
                    <p class="text-xs text-gray-500">Formato PDF</p>
                </div>
            </button>
            
            <button onclick="exportToCSV()" class="flex items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition group cursor-pointer">
                <div class="bg-green-50 p-2 rounded-lg group-hover:bg-green-100 transition">
                    <i class="fas fa-file-excel text-green-600 text-xl"></i>
                </div>
                <div class="text-left ml-3">
                    <p class="font-bold text-gray-800">Exportar Excel</p>
                    <p class="text-xs text-gray-500">Datos .csv</p>
                </div>
            </button>
            
            <button onclick="exportBackup()" class="flex items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition group cursor-pointer">
                <div class="bg-blue-50 p-2 rounded-lg group-hover:bg-blue-100 transition">
                    <i class="fas fa-database text-blue-600 text-xl"></i>
                </div>
                <div class="text-left ml-3">
                    <p class="font-bold text-gray-800">Backup Data</p>
                    <p class="text-xs text-gray-500">Respaldo JSON</p>
                </div>
            </button>
        </div>
    </div>
</div>

<script>
    // --- Datos del Servidor ---
    const statsData = {
        usuarios: Number('<%= stats.usuarios || 0 %>'),
        citas: Number('<%= stats.citas || 0 %>'),
        checkins: Number('<%= stats.checkins || 0 %>'),
        pacientes: Number('<%= stats.pacientes_activos || 0 %>'),
        periodo: '<%= period || "all" %>'
    };

    // --- Inicializaci贸n de Gr谩ficos ---
    document.addEventListener('DOMContentLoaded', function() {
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';

        const ctx1 = document.getElementById('activityChart').getContext('2d');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: ['Usuarios', 'Citas', 'Check-ins', 'Pacientes'],
                datasets: [{
                    label: 'Total',
                    data: [statsData.usuarios, statsData.citas, statsData.checkins, statsData.pacientes],
                    backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(168, 85, 247, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                    borderRadius: 6,
                    barThickness: 40
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        const ctx2 = document.getElementById('distributionChart').getContext('2d');
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Citas', 'Check-ins', 'Usuarios'],
                datasets: [{
                    data: [statsData.citas, statsData.checkins, statsData.usuarios],
                    backgroundColor: ['#10b981', '#a855f7', '#cbd5e1'],
                    hoverOffset: 4,
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
        });
    });

    // --- Funciones de Exportaci贸n ---

    // 1. Exportar a CSV (Excel)
    function exportToCSV() {
        const rows = [
            ["Metrica", "Valor", "Periodo"],
            ["Usuarios Nuevos", statsData.usuarios, statsData.periodo],
            ["Citas Completadas", statsData.citas, statsData.periodo],
            ["Check-ins Emocionales", statsData.checkins, statsData.periodo],
            ["Pacientes Activos", statsData.pacientes, statsData.periodo],
            ["Fecha Reporte", new Date().toLocaleDateString(), ""]
        ];

        let csvContent = "data:text/csv;charset=utf-8,";
        rows.forEach(row => {
            csvContent += row.join(",") + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `MindCare_Analytics_${statsData.periodo}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 2. Exportar a JSON (Backup)
    function exportBackup() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(statsData, null, 2));
        const link = document.createElement("a");
        link.setAttribute("href", dataStr);
        link.setAttribute("download", `backup_metrics_${new Date().toISOString().slice(0,10)}.json`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

<%- include('../partials/footer') %>